---
layout: none
---

#!/bin/bash
#
# Install:
# \curl -s http://boxcar.nicinabox.com/install | bash
#

# Halt on errors
set -e

while (( $# > 0 ))
do
  token="$1"
  shift
  case "$token" in
    noprompt)
      NOPROMPT=true
      ;;
    --version)
      VERSION=$OPTARG
      ;;
    *)
    # Should not occur
      echo "Unknown error while processing options"
      ;;
  esac
done

if [[ ! $NOPROMPT ]]; then
  echo "Hi! You're about to install Boxcar for unRAID. We'll get you setup with a new web interface and command line tool."
  printf "Cool? [y/N] "
  read install_boxcar

  if [[ $install_boxcar != "y" ]]; then
    echo "Bummer, dude."
    exit
  fi
fi

host='https://github.com/nicinabox/boxcar/releases/download'
version=${VERSION-{{ site.version }}}

install () {
  for package in "$@"
  do
    name=`basename $package`

    if [ ! -f /boot/extra/$name ]; then
      echo "Installing $name"
      wget -q $slack_host$package -P /boot/extra
      installpkg /boot/extra/$name
    fi
  done
}

install_with_trolley () {
  for package in "$@"
  do
    trolley install $package
  done
}

# Install trolley
if [[ `command -v trolley` == "" ]]; then
  wget -qO- --no-check-certificate https://raw.github.com/nicinabox/trolley/master/install.sh | sh -
fi

# Install dependencies
deps=('glibc 2.11.1'
      'ncurses 5.9'
      'libmpc 0.8.2'
      'libelf 0.8.13'
      'mpfr 3.0.1'
      'kernel-headers 2.6.37.6_smp'
      'gcc 4.5.2'
      'gcc-g++ 4.5.2'
      'binutils 2.21.51.0.6'
      'make 3.82'
      'automake 1.11.1'
      'openssl 1.0.1c'
      'infozip 6.0'
      'sqlite 3.7.5'
      'libyaml 0.1.4'
      'ruby 1.9.3_p194'
      'ca-certificates')

# TODO: Server doesn't support patches :(
slack_host='http://slackware.cs.utah.edu/pub/slackware'
extra_deps=( '/slackware-13.1/patches/packages/glibc-2.11.1-i486-8_slack13.1.txz'
             '/slackware-14.0/patches/packages/ruby-1.9.3_p448-i486-1_slack14.0.txz')

echo "Fetching dependencies..."
install_with_trolley "${deps[@]}"
install ${extra_deps[@]}

echo "Downloading Boxcar"
boxcar_basename=boxcar-$version-noarch-unraid.tgz
url=$host/$version/$boxcar_basename
wget  -q --no-check-certificate \
      -O /boot/extra/$boxcar_basename \
      $url
installpkg /boot/extra/$boxcar_basename

source /etc/boxcar

if [[ `gem -v` != "2.1.10" ]]; then
  gem update --system
fi

if [[ `command -v bundle` == "" ]]; then
  gem install bundler
fi

bundle --gemfile /usr/apps/boxcar/Gemfile

boxcar server:start

if [[ ! $NOPROMPT ]]; then
  echo "==================================================================="
  echo " Boxcar installed! Visit http://`hostname`:3000 for awesomeness    "
  echo " Report issues at:                                                 "
  echo "  https://github.com/nicinabox/boxcar/issues                       "
  echo ""
  echo " To start using the boxcar command, run \`source /etc/boxcar\`     "
  echo "==================================================================="
fi
